<?php
/*
Plugin Name: 选择模板
Version: 1.0
Plugin URL:
Description: 前台模板随意选择，将模板传至模板目录即可自动读取
Author: 奇遇
Author Email: qiyuuu@gmail.com
Author URL: http://www.qiyuuu.com/
*/
!defined('EMLOG_ROOT') && exit('access deined!');
if(isset($_GET['showtpl']))
{
	setcookie('tpl',$_GET['showtpl']);
	$nonce_templet = $_GET['showtpl'];
}else{
	$nonce_templet = isset($_COOKIE['tpl']) ? $_COOKIE['tpl'] : $nonce_templet;
}
if(isset($_GET['change_templates_js']))
{
	$change_templates_tpl_dir = EMLOG_ROOT.'/content/templates/';
	$change_templates_handle = @opendir($change_templates_tpl_dir) OR die('模板目录未找到！');
	$change_templates_tpls = array();
	while ($change_templates_file = @readdir($change_templates_handle))
	{
		$change_templates_tplfiles = $change_templates_tpl_dir.$change_templates_file.'/header.php';
		if(@filesize($change_templates_tplfiles)>0)
		{
			$change_templates_tpls[] = $change_templates_file;
		}
	}
?>
	document.write('<select onchange="location.href=this.value;">');
	document.write('<option value="">更换模板</option>');
	<?php foreach($change_templates_tpls as $change_templates_value): ?>
	document.write('<option value="<?php echo BLOG_URL."?showtpl=".$change_templates_value; ?>"<?php if($change_templates_value == $nonce_templet): ?> selected="selected"<?php endif;?>><?php echo $change_templates_value; ?></option>');
	<?php endforeach; ?>
	document.write('</select>');
<?php
	exit;
}
$change_templates_custom_widget = $options_cache['custom_widget'] ? @unserialize($options_cache['custom_widget']) : array();
if(!in_array('custom_wg_change_templates',array_keys($change_templates_custom_widget)))//如果没有更换模板的widgets，则添加
{
	//添加
	$change_templates_custom_wg_index = 'custom_wg_change_templates';
	$change_templates_custom_widget[$change_templates_custom_wg_index] = array('title'=>"更换模板",'content'=>'<script type="text/javascript" src="'.BLOG_URL.'index.php?change_templates_js"></script>');
	$change_templates_custom_widget_str = addslashes(serialize($change_templates_custom_widget));
	$DB->query("update ".DB_PREFIX."options set option_value='$change_templates_custom_widget_str' where option_name='custom_widget'");
	$CACHE->updateCache('options');
}
